spack:
  view: false
  definitions:
  - apps:
    - gromacs
    - mpas-model
    - mpich
    - openfoam
    - quantum-espresso
    - wrf
  - targets:
    - target=neoverse_v1
  specs:
  - matrix:
    - [$apps]
    - [$targets]
  ci:
    pipeline-gen:
    - build-job:
        image: {name: ghcr.io/spack/pcluster-amazonlinux-2:v2024-10-07, entrypoint: ['']}
        tags: [aarch64]
        before_script:
        - - . "./share/spack/setup-env.sh"
          - . /etc/profile.d/modules.sh
          - spack --version
          - spack arch
          - export PATH=/home/software/spack/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeh/linux-amzn2-aarch64/gcc-7.3.1/binutils-2.37-2yxz3xsjfmesxujxtlrgcctxlyilynmp/bin:$PATH
          - spack -c "config:install_tree:root:/home/software/spack/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeh" reindex
    - signing-job:
        before_script:
            # Do not distribute Intel & ARM binaries
        - - export SPECS_PATH=${SPACK_BUILDCACHE_RELATIVE_SPECS_PATH}
          - for i in $(aws s3 ls --recursive ${SPACK_REMOTE_MIRROR_OVERRIDE}/${SPECS_PATH}/ | grep intel-oneapi | awk '{print $4}' | sed -e "s?^.*${SPECS_PATH}/??g"); do aws s3 rm ${SPACK_REMOTE_MIRROR_OVERRIDE}/${SPECS_PATH}/$i; done
          - for i in $(aws s3 ls --recursive ${SPACK_REMOTE_MIRROR_OVERRIDE}/${SPECS_PATH}/ | grep armpl | awk '{print $4}' | sed -e "s?^.*${SPECS_PATH}/??g"); do aws s3 rm ${SPACK_REMOTE_MIRROR_OVERRIDE}/${SPECS_PATH}/$i; done
  cdash:
    build-group: AWS Packages

  config:
    shared_linking:
      missing_library_policy: ignore  # due to use of externals

  packages:
    gcc:
      externals:
      - spec: gcc@=12.4.0
        prefix: /home/software/spack/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeh/linux-amzn2-aarch64/gcc-7.3.1/gcc-12.4.0-v6wxye6ijzrxnzxftcwnpu3psohsjl2b
        extra_attributes:
          compilers:
            c: /home/software/spack/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeh/linux-amzn2-aarch64/gcc-7.3.1/gcc-12.4.0-v6wxye6ijzrxnzxftcwnpu3psohsjl2b/bin/gcc
            cxx: /home/software/spack/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeh/linux-amzn2-aarch64/gcc-7.3.1/gcc-12.4.0-v6wxye6ijzrxnzxftcwnpu3psohsjl2b/bin/g++
            fortran: /home/software/spack/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeh/linux-amzn2-aarch64/gcc-7.3.1/gcc-12.4.0-v6wxye6ijzrxnzxftcwnpu3psohsjl2b/bin/gfortran
    acfl:
      require:
      - "%gcc"
      - "target=aarch64"
    gromacs:
      require:
      - gromacs@2024.3 ^armpl-gcc ^openmpi
      - "%gcc"
    libfabric:
      buildable: true
      externals:
      - prefix: /opt/amazon/efa/
        spec: libfabric@1.17.0
      require:
      - fabrics=shm,efa
    llvm:
      variants: ~lldb
    mpas-model:
      require:
      - precision=single ^parallelio+pnetcdf
      - "%gcc"
    mpich:
      require:
      - mpich pmi=pmi2 device=ch4 netmod=ofi +slurm
    nvhpc:
      require:
      - "target=aarch64"
    openfoam:
      require:
      - openfoam ^scotch@6.0.9
    openmpi:
      variants: ~atomics ~cuda ~cxx ~cxx_exceptions ~internal-hwloc ~java +legacylaunchers ~lustre ~memchecker +pmi +romio ~singularity +vt +wrapper-rpath fabrics=ofi schedulers=slurm
      require: '@4:'
    # Palace does not build correctly with armpl until https://github.com/awslabs/palace/pull/207 is merged into a version.
    # palace:
    #   require:
    #     - one_of: ["palace cxxflags=\"-include cstdint\" ^fmt@9.1.0"]
    pmix:
      require: "pmix@3:"
    quantum-espresso:
      require:
      - quantum-espresso@6.6 %gcc ^armpl-gcc
    slurm:
      buildable: false
      externals:
      - prefix: /opt/slurm
        spec: slurm@22.05.8 +pmix
      require:
      - "+pmix"
    all:
      require:
      - "%gcc"
      providers:
        blas: [armpl-gcc, openblas]
        fftw-api: [armpl-gcc, fftw]
        lapack: [armpl-gcc, openblas]
        mpi: [openmpi, mpich]
        scalapack: [netlib-scalapack]
      permissions:
        read: world
        write: user
