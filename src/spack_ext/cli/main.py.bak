"""Main CLI entry point for spack-ext."""

from typing import Optional
import click
from rich.console import Console

from spack_ext import __version__

console = Console()


@click.group()
@click.version_option(version=__version__, prog_name="spack-ext")
@click.option("--verbose", "-v", is_flag=True, help="Enable verbose output")
@click.option("--quiet", "-q", is_flag=True, help="Suppress non-error output")
@click.pass_context
def cli(ctx: click.Context, verbose: bool, quiet: bool) -> None:
    """Spack HPC Extension Framework.

    Modern Python-based tools for Spack configuration management,
    deployment orchestration, and intelligent optimization.
    """
    ctx.ensure_object(dict)
    ctx.obj["verbose"] = verbose
    ctx.obj["quiet"] = quiet


@cli.group()
def config() -> None:
    """Configuration management commands."""
    pass


@config.command("generate")
@click.option(
    "--auto-detect",
    is_flag=True,
    help="Auto-detect system characteristics",
)
@click.option(
    "--arch",
    type=str,
    help="Target architecture (e.g., x86_64_v4, zen4, neoverse_v1)",
)
@click.option(
    "--site",
    type=str,
    help="Site name for configuration",
)
@click.option(
    "--provider",
    type=click.Choice(["aws", "gcp", "azure", "hpc"], case_sensitive=False),
    help="Cloud or HPC provider",
)
@click.option(
    "--instance-type",
    type=str,
    help="Cloud instance type (for cloud providers)",
)
@click.option(
    "--output",
    "-o",
    type=click.Path(),
    required=True,
    help="Output directory for generated configs",
)
@click.pass_context
def config_generate(
    ctx: click.Context,
    auto_detect: bool,
    arch: Optional[str],
    site: Optional[str],
    provider: Optional[str],
    instance_type: Optional[str],
    output: str,
) -> None:
    """Generate HPC site configuration files."""
    verbose = ctx.obj.get("verbose", False)

    if verbose:
        console.print("[blue]Generating configuration...[/blue]")
        console.print(f"  Auto-detect: {auto_detect}")
        console.print(f"  Architecture: {arch}")
        console.print(f"  Site: {site}")
        console.print(f"  Provider: {provider}")
        console.print(f"  Output: {output}")

    from spack_ext.config import ConfigManager

    manager = ConfigManager()
    config = manager.generate(
        auto_detect=auto_detect,
        arch=arch,
        site=site,
        provider=provider,
        instance_type=instance_type,
    )

    manager.write(config, output)

    console.print(f"[green]✓[/green] Configuration generated in: {output}")


@cli.group()
def package() -> None:
    """Package management commands."""
    pass


@package.command("create")
@click.argument("name")
@click.option("--family", type=str, help="Package family (e.g., neuroscience, ml)")
@click.option("--version", type=str, required=True, help="Package version")
@click.option("--deps", type=str, help="Comma-separated dependencies")
@click.pass_context
def package_create(
    ctx: click.Context,
    name: str,
    family: Optional[str],
    version: str,
    deps: Optional[str],
) -> None:
    """Create a new package definition."""
    verbose = ctx.obj.get("verbose", False)

    if verbose:
        console.print(f"[blue]Creating package: {name}[/blue]")

    from spack_ext.packages import PackageManager

    manager = PackageManager()
    pkg = manager.create(
        name=name,
        family=family,
        version=version,
        dependencies=deps.split(",") if deps else [],
    )

    console.print(f"[green]✓[/green] Package created: {pkg.name}")


@package.command("validate")
@click.argument("package_file", type=click.Path(exists=True))
@click.pass_context
def package_validate(ctx: click.Context, package_file: str) -> None:
    """Validate a package definition file."""
    verbose = ctx.obj.get("verbose", False)

    if verbose:
        console.print(f"[blue]Validating: {package_file}[/blue]")

    from spack_ext.packages import PackageManager

    manager = PackageManager()
    is_valid, errors = manager.validate_file(package_file)

    if is_valid:
        console.print(f"[green]✓[/green] Package definition is valid")
    else:
        console.print("[red]✗[/red] Validation failed:")
        for error in errors:
            console.print(f"  • {error}")


@cli.group()
def deploy() -> None:
    """Deployment orchestration commands."""
    pass


@deploy.command("run")
@click.option(
    "--config",
    "-c",
    type=click.Path(exists=True),
    required=True,
    help="Deployment configuration file",
)
@click.option("--dry-run", is_flag=True, help="Show what would be deployed")
@click.option(
    "--stages",
    type=str,
    help="Comma-separated stages to run (default: all)",
)
@click.pass_context
def deploy_run(
    ctx: click.Context,
    config: str,
    dry_run: bool,
    stages: Optional[str],
) -> None:
    """Run deployment pipeline."""
    verbose = ctx.obj.get("verbose", False)

    if verbose:
        console.print("[blue]Starting deployment...[/blue]")
        console.print(f"  Config: {config}")
        console.print(f"  Dry run: {dry_run}")
        console.print(f"  Stages: {stages or 'all'}")

    from spack_ext.deploy import DeploymentOrchestrator

    orchestrator = DeploymentOrchestrator()
    orchestrator.load_config(config)

    stage_list = stages.split(",") if stages else None

    if dry_run:
        orchestrator.dry_run(stages=stage_list)
        console.print("[yellow]Dry run completed[/yellow]")
    else:
        deployment_id = orchestrator.execute(stages=stage_list)
        console.print(f"[green]✓[/green] Deployment completed: {deployment_id}")


@cli.group()
def optimize() -> None:
    """CPU optimization commands."""
    pass


@optimize.command("detect")
@click.pass_context
def optimize_detect(ctx: click.Context) -> None:
    """Detect current CPU capabilities."""
    verbose = ctx.obj.get("verbose", False)

    from spack_ext.optimize import OptimizationEngine

    engine = OptimizationEngine()
    info = engine.detect_cpu()

    console.print("[bold]CPU Information:[/bold]")
    console.print(f"  Brand: {info.brand}")
    console.print(f"  Architecture: {info.arch}")
    console.print(f"  Features: {', '.join(info.features[:10])}")

    if verbose:
        console.print(f"\n  All features: {', '.join(info.features)}")


@optimize.command("recommend")
@click.option("--package", type=str, help="Package name for recommendations")
@click.pass_context
def optimize_recommend(ctx: click.Context, package: Optional[str]) -> None:
    """Show optimization recommendations."""
    from spack_ext.optimize import OptimizationEngine

    engine = OptimizationEngine()
    recommendations = engine.get_recommendations(package=package)

    console.print("[bold]Optimization Recommendations:[/bold]")
    for key, value in recommendations.items():
        console.print(f"  {key}: {value}")


if __name__ == "__main__":
    cli()
